{% extends "base.html" %}

{% block title %}File Complaint{% endblock %}

{% block content %}
<style>
    .horizontal-form {
        max-width: 900px;
        margin: 0 auto;
        padding: 2rem;
    }
    .form-title {
        text-align: center;
        margin-bottom: 2rem;
        color: #3f51b5;
    }
    .form-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1.5rem;
    }
    .full-width {
        grid-column: span 2;
    }
    .form-actions {
        grid-column: span 2;
        text-align: center;
        margin-top: 1.5rem;
    }
    .file-upload-wrapper {
        margin-top: 0.5rem;
    }
    .department-info {
        background-color: #f8f9fa;
        padding: 1rem;
        border-radius: 0.5rem;
        margin-bottom: 1rem;
    }
    @media (max-width: 768px) {
        .form-grid {
            grid-template-columns: 1fr;
        }
        .full-width, .form-actions {
            grid-column: span 1;
        }
    }
</style>

<div class="horizontal-form">
    <h1 class="form-title">File Complaint</h1>
    
    <form method="POST" action="{{ url_for('file_complaint') }}" enctype="multipart/form-data" novalidate>
        <div class="form-grid">

            <!-- Department Selection -->
            <div class="mb-2 full-width">
                <label for="department" class="form-label">Department*</label>
                <select class="form-select" id="department" name="department" required aria-label="Select Department">
                    <option value="" selected disabled>Select department</option>
                    {% for department in departments %}
                        <option value="{{ department.id }}">{{ department.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Department Info -->
            <div class="department-info full-width" id="departmentInfo">
                <h5><i class="bi bi-building me-2"></i> <span id="deptName">Select a department first</span></h5>
                <p class="mb-1"><i class="bi bi-info-circle me-2"></i> <span id="deptDescription">After selecting a department, you'll see relevant complaint categories</span></p>
                <p class="mb-0"><i class="bi bi-clock-history me-2"></i> Average resolution time: <span id="deptResolutionTime">Varies by department</span></p>
            </div>

            <!-- Category Selection (will be populated dynamically) -->
            <div class="mb-3 full-width">
                <label for="category" class="form-label">Category*</label>
                <select class="form-select" id="category" name="category" required aria-label="Complaint Category" disabled>
                    <option value="" selected disabled>Please select a department first</option>
                </select>
            </div>

            <!-- Row 1 -->
            <div class="mb-3">
                <label for="priority" class="form-label">Priority*</label>
                <select class="form-select" id="priority" name="priority" required aria-label="Priority Level">
                    <option value="" selected disabled>Select priority</option>
                    <option value="High" class="priority-high">High (Urgent attention needed)</option>
                    <option value="Medium" class="priority-medium">Medium (Important but not urgent)</option>
                    <option value="Low" class="priority-low">Low (General issue)</option>
                </select>
            </div>

            <div class="mb-3">
                <label for="locality" class="form-label">Locality/Area/Street*</label>
                <input type="text" class="form-control" id="locality" name="locality" required placeholder="e.g., Ayodhya Chowk" aria-label="Locality">
            </div>

             <!-- Row 2 -->
            <div class="mb-3">
                <label for="city" class="form-label">City*</label>
                <input type="text" class="form-control" id="city" name="city" required placeholder="e.g., Rajkot" aria-label="City">
            </div>

            <div class="mb-3">
                <label for="pincode" class="form-label">Pincode*</label>
                <input type="text" class="form-control" id="pincode" name="pincode" pattern="[0-9]{6}" maxlength="6" required aria-label="Pincode" placeholder="6-digit code">
                <small class="text-muted">6-digit postal code</small>
            </div>

            <!-- Row 3 -->
            <div class="mb-3">
                <label for="landmark" class="form-label">Landmark (Optional)</label>
                <input type="text" class="form-control" id="landmark" name="landmark" placeholder="e.g., Near by ..." aria-label="Landmark">
            </div>

            <div class="mb-3">
                <label for="image" class="form-label">Upload Image (Optional)</label>
                <input class="form-control" type="file" id="image" name="image" accept="image/*" aria-label="Upload Image">
                <div class="file-upload-preview mt-2">
                    <img id="image-preview" src="#" alt="Image Preview" style="max-width: 200px; display: none;">
                </div>
                <small class="text-muted">Max 5MB (JPEG, PNG, GIF)</small>
            </div>

            <!-- Row 4 -->
            <div class="mb-3 full-width">
                <label for="description" class="form-label">Description*</label>
                <textarea class="form-control" id="description" name="description" rows="4" required aria-label="Complaint Description" placeholder="Please describe the issue in detail"></textarea>
            </div>

            <!-- Submit Button -->
            <div class="form-actions">
                <button type="submit" class="btn btn-primary btn-lg">
                    <i class="bi bi-send-check me-2"></i> Submit Complaint
                </button>
            </div>
        </div>
    </form>
</div>

<script>
// Image preview
document.getElementById('image').addEventListener('change', function () {
    const preview = document.getElementById('image-preview');
    if (this.files && this.files[0]) {
        const reader = new FileReader();
        reader.onload = function (e) {
            preview.src = e.target.result;
            preview.style.display = 'block';
        };
        reader.readAsDataURL(this.files[0]);
    }
});

// Pincode validation
document.getElementById('pincode').addEventListener('input', function () {
    this.value = this.value.replace(/\D/g, '').slice(0, 6);
});

// Department change: Load categories and update department info
document.getElementById('department').addEventListener('change', function () {
    const deptId = this.value;
    const categorySelect = document.getElementById('category');
    const deptInfo = document.getElementById('departmentInfo');
    
    if (!deptId) {
        categorySelect.innerHTML = '<option value="" selected disabled>Please select a department first</option>';
        categorySelect.disabled = true;
        return;
    }
    
    // Fetch categories for the selected department
    fetch(`/get_categories?department_id=${deptId}`)
        .then(response => response.json())
        .then(data => {
            // Populate categories
            categorySelect.innerHTML = '<option value="" selected disabled>Select category</option>';
            data.categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.name;
                option.textContent = category.name;
                option.dataset.deptDesc = category.description || 'Will be processed by the department';
                option.dataset.resolution = category.resolution_time || '2-3 working days';
                categorySelect.appendChild(option);
            });
            categorySelect.disabled = false;
            
            // Update department info
            document.getElementById('deptName').textContent = this.options[this.selectedIndex].text;
            document.getElementById('deptDescription').textContent = data.department_description || 'Your complaint will be processed by this department';
            document.getElementById('deptResolutionTime').textContent = data.department_resolution_time || '2-3 working days';
        })
        .catch(error => {
            console.error('Error fetching categories:', error);
            categorySelect.innerHTML = '<option value="" selected disabled>Error loading categories</option>';
        });
});

// Category change: Update department info with category-specific details
document.getElementById('category').addEventListener('change', function () {
    const selected = this.options[this.selectedIndex];
    if (selected && selected.value) {
        document.getElementById('deptDescription').textContent = selected.dataset.deptDesc;
        document.getElementById('deptResolutionTime').textContent = selected.dataset.resolution;
    }
});

// Form validation on submit
document.querySelector('form').addEventListener('submit', function (e) {
    const pincode = document.getElementById('pincode');
    if (pincode.value.length !== 6) {
        alert('Please enter a valid 6-digit pincode.');
        pincode.focus();
        e.preventDefault();
        return false;
    }

    const fileInput = document.getElementById('image');
    if (fileInput.files.length > 0) {
        const file = fileInput.files[0];
        const validTypes = ['image/jpeg', 'image/png', 'image/gif'];
        const maxSize = 5 * 1024 * 1024;

        if (!validTypes.includes(file.type)) {
            alert('Please upload only JPEG, PNG, or GIF images.');
            e.preventDefault();
            return false;
        }

        if (file.size > maxSize) {
            alert('Image size should be less than 5MB.');
            e.preventDefault();
            return false;
        }
    }

    return true;
});
</script>
{% endblock %}