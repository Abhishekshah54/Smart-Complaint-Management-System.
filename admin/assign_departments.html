{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="card shadow">
        <div class="card-header bg-primary text-white">
            <h2 class="mb-0">
                <i class="fas fa-user-shield me-2"></i>Assign Departments to Administrators
            </h2>
        </div>
        
        <div class="card-body">
            <form method="POST" action="{{ url_for('assign_departments') }}">
                <div class="form-group">
                    <label for="admin_id" class="font-weight-bold">Select Administrator</label>
                    <select class="form-control select2" id="admin_id" name="admin_id" required>
                        <option value="">-- Select an administrator --</option>
                        {% for admin in admins %}
                        <option value="{{ admin.id }}">{{ admin.name }} ({{ admin.email }})</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group mt-4">
                    <label class="font-weight-bold">Department Access</label>
                    <p class="text-muted">Select which departments this administrator should have access to manage</p>
                    
                    <div class="department-container border rounded p-3" style="max-height: 400px; overflow-y: auto;">
                        <div class="row">
                            {% for dept in departments %}
                            <div class="col-md-6 mb-2">
                                <div class="custom-control custom-checkbox">
                                    <input type="checkbox" class="custom-control-input me-3" 
                                        name="department_ids" 
                                        id="dept_{{ dept.id }}" 
                                        value="{{ dept.id }}">
                                    <label class="custom-control-label" for="dept_{{ dept.id }}">
                                        <span class="badge badge-primary bg-primary mr-3">{{ dept.id }}</span>
                                        {{ dept.name }}
                                    </label>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                
                <div class="form-group text-right mt-4">
                    <button type="submit" class="btn btn-success px-4">
                        <i class="fas fa-save me-2"></i>Save Assignments
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Include Select2 CSS and JS for enhanced select elements -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
$(document).ready(function() {
    // Initialize Select2 for the admin dropdown
    $('.select2').select2({
        placeholder: "-- Select an administrator --",
        width: '100%'
    });
    
    // Load department assignments when admin changes
    $('#admin_id').on('change', function() {
        const adminId = this.value;
        if (!adminId) {
            // Clear all checkboxes if no admin selected
            $('input[name="department_ids"]').prop('checked', false);
            return;
        }
        
        // Show loading state
        const departmentContainer = $('.department-container');
        departmentContainer.addClass('loading');
        
        fetch(`/admin/get_admin_departments/${adminId}`)
            .then(response => response.json())
            .then(departments => {
                // Clear all checkboxes
                $('input[name="department_ids"]').prop('checked', false);
                
                // Check the ones this admin is assigned to
                departments.forEach(dept => {
                    $(`#dept_${dept.id}`).prop('checked', true);
                });
            })
            .finally(() => {
                departmentContainer.removeClass('loading');
            });
    });
    
    // Initialize with first admin selected if needed
    // $('#admin_id').trigger('change');
});
</script>

<style>
    .department-container {
        background-color: #f8f9fa;
        transition: all 0.3s ease;
    }
    
    .department-container.loading {
        opacity: 0.7;
        pointer-events: none;
    }
    
    .custom-checkbox .custom-control-label::before {
        border-radius: 0.25rem;
    }
    
    .select2-container--default .select2-selection--single {
        height: calc(1.5em + 0.75rem + 2px);
        padding: 0.375rem 0.75rem;
    }
    
    .card {
        border-radius: 0.5rem;
    }
    
    .card-header {
        border-radius: 0.5rem 0.5rem 0 0 !important;
    }
</style>
{% endblock %}